export default class D3Graph {
    constructor(svg, sourceData) {
        this.svg = svg
        this.sourceData = sourceData
        this.computedData = this.computeData(sourceData)
        this.originPointerPosition = null
        this.generateColor = d3.scaleOrdinal(d3.schemeCategory10)
        this.dragHandler = d3.drag()
            .on('start', () => {
                const { x, y } = d3.event
                this.originPointerPosition = { x, y }
            })
            .on('drag', () => {
                const { x, y } = d3.event
                const viewBox = this.svg.node().viewBox.baseVal

                this.setViewBox({
                    x: viewBox.x + this.originPointerPosition.x - x,
                    y: viewBox.y + this.originPointerPosition.y - y
                })
            })
    }

    findIndexByName (name) {
        return this.sourceData.findIndex(data => data.name === name)
    }

    setBodyKeyEvent () {
        const body = d3.select('body')
        body.on('keydown', () => {
            if (d3.event.code === 'Backspace') {
                this.svg.transition().attr('viewBox', `0, 0, 1000, 1000`)
            }
        })
    }

    setSvg () {
        return this.svg.attr('preserveAspectRatio', 'xMidYMid meet')
            .style('width', '100%')
            .style('height', '100%')
            .style('background-color', '#FFFFFF')
    }

    setViewBox({ x = 0, y = 0, width = 1000, height = 1000 } = {}) {
        const viewBox = this.svg.node().viewBox.baseVal
        viewBox.x = x
        viewBox.y = y
        viewBox.width = width
        viewBox.height = height

        if (this.background) {
            this.background.attr('x', x - 1000)
                .attr('y', y - 1000)
        }
    }
    
    drawBackground () {
        this.background = this.svg.append('rect')
            .attr('x', -1000)
            .attr('y', -1000)
            .attr('width', 4000)
            .attr('height', 4000)
            .attr('fill', '#CDCDCD')
            .style('cursor', 'grab')

        return this.background
    }
}
